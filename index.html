<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Formation QSE - Plateforme de Formation Obligatoire</title>
    <style>
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --danger: #dc2626;
            --warning: #ea580c;
            --bg: #f8fafc;
            --text: #1e293b;
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        .header {
            text-align: center;
            padding: 40px 20px;
            background: white;
            border-radius: 12px;
            margin-bottom: 30px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        .logo {
            background: var(--primary);
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            font-weight: bold;
            font-size: 1.5rem;
            display: inline-block;
            margin-bottom: 20px;
        }
        h1 {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        .subtitle {
            color: #64748b;
            font-size: 1.1rem;
        }
        .nav {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 40px;
        }
        .nav-card {
            background: white;
            padding: 30px;
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border: 2px solid transparent;
        }
        .nav-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0,0,0,0.15);
            border-color: var(--primary);
        }
        .nav-icon {
            font-size: 3rem;
            margin-bottom: 15px;
        }
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 1rem;
            margin: 5px;
            display: inline-block;
        }
        .btn-primary {
            background: var(--primary);
            color: white;
        }
        .btn-primary:hover {
            background: #1d4ed8;
            transform: scale(1.05);
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .quiz-container {
            background: white;
            padding: 30px;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .question-box {
            margin-bottom: 30px;
            padding: 20px;
            background: #f8fafc;
            border-radius: 8px;
            border: 2px solid #e2e8f0;
        }
        .question-box.error {
            border-color: var(--danger);
            background: #fee;
        }
        .question-title {
            font-weight: 600;
            margin-bottom: 15px;
            font-size: 1.1rem;
        }
        .option {
            margin: 10px 0;
            padding: 12px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .option:hover {
            background: #f1f5f9;
        }
        .option input {
            margin-right: 10px;
        }
        .signature-pad {
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            cursor: crosshair;
            background: white;
        }
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }
        .modal.active {
            display: flex;
        }
        .modal-content {
            background: white;
            padding: 40px;
            border-radius: 12px;
            max-width: 500px;
            width: 90%;
            text-align: center;
        }
        .score-display {
            font-size: 4rem;
            font-weight: bold;
            margin: 20px 0;
        }
        input[type="text"] {
            width: 100%;
            padding: 12px;
            border: 2px solid #cbd5e1;
            border-radius: 8px;
            font-size: 1rem;
            margin-bottom: 15px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="logo">üõ°Ô∏è QSE</div>
            <h1>Formations Obligatoires</h1>
            <p class="subtitle">Plateforme de formation et tra√ßabilit√© QSE</p>
        </div>

        <div class="nav" id="mainNav">
            <div class="nav-card" onclick="showSection('salarie')">
                <div class="nav-icon">üë∑</div>
                <h2>Espace Salari√©</h2>
                <p>Acc√©der aux formations</p>
            </div>
            <div class="nav-card" onclick="showSection('admin')">
                <div class="nav-icon">‚öôÔ∏è</div>
                <h2>Administration</h2>
                <p>G√©rer les formations</p>
            </div>
        </div>

        <!-- Section Salari√© -->
        <div id="salarieSection" class="section">
            <div class="quiz-container">
                <h2>Formations disponibles</h2>
                <button class="btn btn-primary" onclick="startFormation('current')">üìö Formation du mois</button>
                <button class="btn btn-primary" onclick="showSection('home')">‚Üê Retour</button>
            </div>
        </div>

        <!-- Section Quiz -->
        <div id="quizSection" class="section">
            <div class="quiz-container">
                <h2 id="formationTitle">Formation</h2>
                <div id="quizContent"></div>
                
                <h3 style="margin-top: 30px;">Vos informations</h3>
                <input type="text" id="nom" placeholder="Nom" required>
                <input type="text" id="prenom" placeholder="Pr√©nom" required>
                <input type="text" id="service" placeholder="Service" required>
                
                <h3 style="margin-top: 20px;">Signature</h3>
                <canvas id="signaturePad" class="signature-pad" width="600" height="200"></canvas>
                <div style="margin-top: 10px;">
                    <button class="btn" onclick="clearSignature()">üóëÔ∏è Effacer</button>
                </div>
                
                <div style="margin-top: 30px;">
                    <button class="btn btn-primary" onclick="validateQuiz()">‚úÖ Valider l'attestation</button>
                    <button class="btn" onclick="showSection('salarie')">‚Üê Retour</button>
                </div>
            </div>
        </div>

        <!-- Section Admin -->
        <div id="adminSection" class="section">
            <div class="quiz-container">
                <h2>Administration</h2>
                <p>‚úÖ Les attestations sont automatiquement centralis√©es dans votre Google Sheet !</p>
                <p>üìä Consultez votre Google Sheet pour voir toutes les attestations.</p>
                <button class="btn btn-primary" onclick="showSection('home')">‚Üê Retour</button>
            </div>
        </div>

        <!-- Modal Score -->
        <div id="scoreModal" class="modal">
            <div class="modal-content">
                <div id="scoreDisplay"></div>
                <button class="btn btn-primary" onclick="closeScoreModal()">Fermer</button>
            </div>
        </div>
    </div>

    <script>
// URL du Webhook Apps Script (Google Sheet)
const WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbwTdpoGg93wShXfBZXF6V7VrvjzZNdXrMsEAIJWUYJ7AfYF1EGFke76EtVJoP4xg1s/exec';

        // DONN√âES PR√â-CHARG√âES
        const INITIAL_DATA = {
            formations: [{"id":"f1770217691908","titre":"Risque Routier","mois":"2026-01","is_current":true,"pdf_url":"https://drive.google.com/file/d/1ctZn0PsKmROGEwV_1-od3-oLzVZa8Nlk/view?usp=sharing","questions":[{"question":"0,20g √† 0,25g d'alcool dans le sang correspond √†: ","type":"radio","options":["1 bi√®re ","1 verre de vin ","1 bi√®re et un verre de vin blanc "],"correct_answers":[1]},{"question":"La premi√®re cause d'accidents de la route est : ","type":"radio","options":["L'alcool ","La drogue ","La vitesse excessive "],"correct_answers":[2]},{"question":"Je conduis fatigu√© et ressens l'envie de dormir. Je‚Ä¶ ","type":"checkbox","options":["Consulte un m√©decin ","Met le volume √† fond et ouvre les fen√™tres pour me r√©veiller ","Passe le volant √† un coll√®gue ayant le permis ","Si je suis seul, je fais une pause et pr√©viens mon responsable d'un l√©ger retard "],"correct_answers":[2,3]},{"question":"Je n'ai plus de permis, puis-je conduire les v√©hicules SNEF? ","type":"radio","options":["Oui d'apr√®s l'article R4526-3 du code du travail les v√©hicules de soci√©t√© ne sont pas concern√©s ","Non c'est formellement interdit ","Oui avec une autorisation de l'employeur "],"correct_answers":[1]},{"question":"Envoyer un SMS pendant 3 secondes, en conduisant n'augmente pas le risque d'accident ","type":"radio","options":["Vrai ","Faux "],"correct_answers":[1]},{"question":"Mon coll√®gue conduit et ne cesse de r√©pondre au t√©l√©phone ","type":"radio","options":["Ce n'est pas mon probl√®me ","Ce n'est pas dangereux, je l'averti des dangers ","Je prends le volant "],"correct_answers":[2]},{"question":"Je dois me rendre sur un chantier mais je suis en retard ","type":"radio","options":["Je vais sur le chantier le plus rapidement possible ","Je pr√©viens mon charg√© d'affaire de mon retard et roule prudemment ","Je prends des petites routes pour √©viter les contr√¥les de police "],"correct_answers":[1]},{"question":"Les accidents de la route repr√©sentent ‚Ä¶.% des accidents mortels li√©s au travail. ","type":"radio","options":["15% ","30% ","33% "],"correct_answers":[1]},{"question":"Ma vidange est √† faire sous peu ","type":"radio","options":["Pas mon probl√®me, c'est un v√©hicule SNEF ce n'est pas √† moi de g√©rer √ßa ","Je programme l'intervention dans un centre agr√©√© ","Je la fais moi-m√™me √† la maison "],"correct_answers":[1]},{"question":"Je suis responsable de mon v√©hicule et de son bon entretien ","type":"radio","options":["Vrai ","Faux "],"correct_answers":[0]}],"created":"2026-02-04T15:08:11.908Z"}],
            attestations: []
        };

        if (!localStorage.getItem('formations')) {
            localStorage.setItem('formations', JSON.stringify(INITIAL_DATA.formations));
        }
        if (!localStorage.getItem('attestations')) {
            localStorage.setItem('attestations', JSON.stringify(INITIAL_DATA.attestations));
        }

        const DB = {
            getFormations: () => JSON.parse(localStorage.getItem('formations') || '[]'),
            saveFormations: (data) => localStorage.setItem('formations', JSON.stringify(data)),
            getAttestations: () => JSON.parse(localStorage.getItem('attestations') || '[]'),
            saveAttestations: (data) => localStorage.setItem('attestations', JSON.stringify(data))
        };

        let currentFormation = null;
        let isDrawing = false;

        function showSection(section) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.getElementById('mainNav').style.display = section === 'home' ? 'grid' : 'none';
            
            if (section === 'salarie') {
                document.getElementById('salarieSection').classList.add('active');
            } else if (section === 'admin') {
                document.getElementById('adminSection').classList.add('active');
            } else if (section === 'quiz') {
                document.getElementById('quizSection').classList.add('active');
            }
        }

        function startFormation(type) {
            const formations = DB.getFormations();
            currentFormation = formations.find(f => f.is_current);
            
            if (!currentFormation) {
                alert('Aucune formation disponible');
                return;
            }
            
            document.getElementById('formationTitle').textContent = currentFormation.titre;
            
            let html = '';
            currentFormation.questions.forEach((q, idx) => {
                html += `<div class="question-box" id="question_${idx}_box">`;
                html += `<div class="question-title">${idx + 1}. ${q.question}</div>`;
                
                q.options.forEach((opt, optIdx) => {
                    const inputType = q.type === 'checkbox' ? 'checkbox' : 'radio';
                    html += `<div class="option">
                        <label>
                            <input type="${inputType}" name="question_${idx}" value="${optIdx}">
                            ${opt}
                        </label>
                    </div>`;
                });
                
                html += `</div>`;
            });
            
            document.getElementById('quizContent').innerHTML = html;
            
            const canvas = document.getElementById('signaturePad');
            const ctx = canvas.getContext('2d');
            
            canvas.addEventListener('mousedown', () => isDrawing = true);
            canvas.addEventListener('mouseup', () => isDrawing = false);
            canvas.addEventListener('mousemove', (e) => {
                if (!isDrawing) return;
                const rect = canvas.getBoundingClientRect();
                ctx.lineTo(e.clientX - rect.left, e.clientY - rect.top);
                ctx.stroke();
            });
            
            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                isDrawing = true;
            });
            canvas.addEventListener('touchend', () => isDrawing = false);
            canvas.addEventListener('touchmove', (e) => {
                if (!isDrawing) return;
                e.preventDefault();
                const rect = canvas.getBoundingClientRect();
                const touch = e.touches[0];
                ctx.lineTo(touch.clientX - rect.left, touch.clientY - rect.top);
                ctx.stroke();
            });
            
            showSection('quiz');
        }

        function clearSignature() {
            const canvas = document.getElementById('signaturePad');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        async function validateQuiz() {
            const nom = document.getElementById('nom').value.trim();
            const prenom = document.getElementById('prenom').value.trim();
            const service = document.getElementById('service').value.trim();
            
            if (!nom || !prenom || !service) {
                alert('‚ö†Ô∏è Veuillez remplir tous les champs');
                return;
            }
            
            const canvas = document.getElementById('signaturePad');
            const ctx = canvas.getContext('2d');
            const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
            let hasSignature = false;
            for (let i = 0; i < imageData.data.length; i += 4) {
                if (imageData.data[i + 3] > 0) {
                    hasSignature = true;
                    break;
                }
            }
            
            if (!hasSignature) {
                alert('‚ö†Ô∏è Veuillez signer avant de valider');
                return;
            }
            
            const f = currentFormation;
            const reponses = {};
            let score = 0;
            let hasError = false;
            
            document.querySelectorAll('.question-box').forEach(box => {
                box.classList.remove('error');
            });
            
            f.questions.forEach((q, idx) => {
                const name = `question_${idx}`;
                const inputs = document.querySelectorAll(`input[name="${name}"]:checked`);
                const userAnswers = Array.from(inputs).map(i => parseInt(i.value));
                
                if (userAnswers.length === 0) {
                    hasError = true;
                    const questionBox = document.getElementById(`question_${idx}_box`);
                    if (questionBox) {
                        questionBox.classList.add('error');
                        questionBox.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                }
                
                reponses[name] = userAnswers;
                
                const correctAnswers = q.correct_answers.sort();
                const userAnswersSorted = userAnswers.sort();
                
                if (JSON.stringify(correctAnswers) === JSON.stringify(userAnswersSorted)) {
                    score++;
                }
            });
            
            if (hasError) {
                alert('‚ö†Ô∏è Veuillez r√©pondre √† TOUTES les questions avant de valider !');
                return;
            }
            
            const scorePercent = Math.round((score / f.questions.length) * 100);
            
            const signature = document.getElementById('signaturePad').toDataURL('image/jpeg', 0.7);
            
            const attestations = DB.getAttestations();
            const attestationData = {
                id: 'a' + Date.now(),
                formation_id: f.id,
                formation_titre: f.titre,
                nom,
                prenom,
                service,
                reponses,
                score: scorePercent,
                signature,
                date: new Date().toISOString()
            };
            
            attestations.push(attestationData);
            DB.saveAttestations(attestations);
            
            // Envoyer vers Make.com
            await sendToMakeCom(attestationData);
            
            showScore(scorePercent, score, f.questions.length);
        }

        async function sendToMakeCom(data) {
  try {
    // Limite la taille de la signature pour √©viter de d√©passer les limites de cellule
    if (data.signature && data.signature.length > 40000) {
      data.signature = data.signature.substring(0, 40000);
    }
    const res = await fetch(WEBHOOK_URL, {
      method: 'POST',
      headers: { 'Content-Type': 'text/plain;charset=utf-8' },
      body: JSON.stringify(data),
      redirect: 'follow'
    });
    if (!res.ok) throw new Error('HTTP ' + res.status);
    console.log('‚úÖ Attestation envoy√©e au Google Sheet via Apps Script');
  } catch (error) {
    console.error('‚ùå Erreur envoi Apps Script:', error);
    // On garde l'attestation en localStorage (d√©j√† fait avant l'envoi)
  }
}
        }

        function showScore(percent, correct, total) {
            let color = percent >= 70 ? 'var(--success)' : (percent >= 50 ? 'var(--warning)' : 'var(--danger)');
            let icon = percent >= 70 ? 'üéâ' : (percent >= 50 ? '‚ö†Ô∏è' : '‚ùå');
            
            document.getElementById('scoreDisplay').innerHTML = `
                ${icon}
                <div class="score-display" style="color:${color}">${percent}%</div>
                <p style="font-size:1.2rem;margin-bottom:20px;">${correct} bonne(s) r√©ponse(s) sur ${total}</p>
                <p>‚úÖ Votre attestation a √©t√© enregistr√©e et envoy√©e !</p>
            `;
            document.getElementById('scoreModal').classList.add('active');
        }

        function closeScoreModal() {
            document.getElementById('scoreModal').classList.remove('active');
            showSection('salarie');
        }

        window.onload = () => {
            console.log('‚úÖ Site de formation QSE charg√© - Formation "Risque Routier" pr√©-charg√©e');
            console.log('üìä Connexion Google Forms + Google Sheets activ√©e');
            console.log('üéØ Chaque attestation sera automatiquement centralis√©e !');
        };
    </script>
</body>
</html>
